<!DOCTYPE html>
<html lang="en" itemscope="itemscope" itemtype="http://schema.org/WebPage">
<head>
    <meta charset="utf-8" />
    <title>MexApi: Time Machine’ish backups under Linux</title>

    <link rel="icon" href="http://mexapi.macpress.com.br/favicon.ico" sizes="16x16 24x24 32x32 57x57 64x64 72x72 96x96 110x110 114x114 128x128 195x195 256x256" type="image/vnd.microsoft.icon">

    <meta name="author" content="Deny Dias" />
    <meta name="description" itemprop="description" content="Deny Dias personal weblog. Includes his blog, links to his social accounts and resume. This is not an API." />
    <meta name="copyright" content="MexApi is licensed under CC BY-SA 3.0." />

    <link href="http://mexapi.macpress.com.br/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="MexApi RSS Feed" />
    <link href="http://mexapi.macpress.com.br/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="MexApi Atom Feed" />

    <!-- Mobile viewport optimized: j.mp/bplateviewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" type="text/css" media="all" href="http://mexapi.macpress.com.br/theme/min-0681a3c9.css" />
    
    <script src="http://mexapi.macpress.com.br/theme/js/libs/modernizr-2.6.2.min.js"></script>
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

<!-- Place this tag where you want the +1 button to render. -->

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-43437542-1', 'MexApi');
      ga('send', 'pageview');

    </script>
</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1 class="sitesubtitle"><a href="http://mexapi.macpress.com.br">MexApi</a></h1>
                  <h4 class="sitesubtitle"><a href="http://mexapi.macpress.com.br"><strong>This is not an API</strong></a></h4>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="http://mexapi.macpress.com.br">Home</a></li>

                            <li><a href="http://mexapi.local/archives.html">Archives</a></li>
                            <li><a href="http://about.me/denydias">About Me</a></li>
                                                  
              </ul>
            </div>

          <section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="http://mexapi.macpress.com.br/2013/04/time-machineish-backups-under-linux.html" rel="bookmark"
                   title="Permalink to Time Machine’ish backups under Linux">Time Machine&#8217;ish backups under&nbsp;Linux</a></h2>
                      
            </header>
            <footer class="post-info">
              <abbr class="published" title="2013-04-20T01:11:00">
                Sat Apr 20 01:11:00 2013
              </abbr>
                            <address class="vcard author">
                By Deny Dias
              </address>
                          </footer><!-- /.post-info -->
                        <div class="entry-content">
              <p>When I <a class="reference external" href="http://mexapi.macpress.com.br/2012/11/subversao-tecnologica-do-mac-os-x-para.html">switched</a> from Mac <span class="caps">OS</span> X to Slackware on my old MacBook Pro
7,1, I´ve <a class="reference external" href="https://www.google.com.br/webhp?oq=linux+rsyc+snapshot#q=linux+rsync+snapshot">read</a> a lot about rsync snapshot backups. It works, indeed.
It just don’t work so smooth and unattended as Time Machine did in Mac
<span class="caps">OS</span> X. There were two features I missed most under Linux/rsync setup:</p>
<ol class="arabic simple">
<li>The ability to backup to different mounts under different networks.</li>
<li>Make the system completely ignore backup tasks if I’m plugged to a
network where I do not have a backup drive.</li>
</ol>
<p>I work mainly at home. Here I do have a beautiful piece of appliance
from Synology, <a class="reference external" href="http://www.synology.com/us/products/DS211+/index.php"><span class="caps">DS211</span>+</a>, that provides me a full <span class="caps">2TB</span> <span class="caps">NAS</span> with <span class="caps">NFS</span>,
mirrored <span class="caps">RAID</span>, backups itself to an external <span class="caps">USB</span> drive and many others
storage bells and whistles. This is my primary backup facility. When I’m
at home, I want my backups sent to my <span class="caps">NFS</span> mount at <span class="caps">DS</span> each four hours.</p>
<p>When I’m at the office tough, I count on an old Apple Time Capsule
which provides me <span class="caps">500GB</span> over <span class="caps">AFP</span> or <span class="caps">SMB</span>. No frills and all the ugly
Apple closeness. But I’m still able to mount it using either <span class="caps">AFP</span> or <span class="caps">SMB</span>
on Linux.</p>
<p>When I hit the road, I still use an yet older <span class="caps">150GB</span> external <span class="caps">USB</span> drive
as a backup storage.</p>
<p>Under <span class="caps">OS</span> X, deal with all this different storage destinations for Time
Machine backup was a piece of cake. But at Linux this shows to be
challenging. When I was updating my knowledge about rsync backups, it
became clear very quickly that rsync can’t deal with multiple, dynamic
destinations. That’s not rsync job. rsync’s job is to move files way
around with confidence.</p>
<p>Then <a class="reference external" href="http://www.rsnapshot.org/">rsnapshot</a> came to me. From it’s website:</p>
<blockquote>
rsnapshot is a filesystem snapshot utility for making backups of
local and remote systems.</blockquote>
<p>Just what I was looking for: local and remote backups. But there’s a
catch: rsnapshot can’t deal with dynamic mount points under different
networks too. It just expect that remote destination is already mounted
upon backup start.</p>
<p>I couldn’t find any viable solution to make this happen so easily and
unattended as it was under Mac <span class="caps">OS</span> X’s Time Machine.</p>
<p>So I decided to write my own piece of code to do it: <a class="reference external" href="https://github.com/denydias/nsnapshot">nsnapshot</a>.</p>
<p>It relies on rsnapshot and takes tree arrays of parameters to decide
where a backup should sit: network address, mount point and a force field.</p>
<p>The network parameter is the network address where the backup should
happen. For instance, let’s say your <span class="caps">IP</span> is <tt class="docutils literal">192.168.173.40</tt>. Your network
address on this network is <tt class="docutils literal">192.168.173.0</tt>.</p>
<p>The mount point is the networked storage resource where your backup is
sent to. Of course this should be set under <tt class="docutils literal">/etc/fstab</tt> first I’ll leave
this as an exercise for the reader.</p>
<p>Finally, the force field says to <tt class="docutils literal">nsnapshot</tt> that it should backup to
that mount point regardless your machine is on that network or not.
Great for locally mounted devices such as my old <span class="caps">USB</span> drive.</p>
<p>After set <tt class="docutils literal">nsnapshot</tt> and <tt class="docutils literal">rsnapshot.conf</tt> up, <tt class="docutils literal">chmod +x</tt> on <tt class="docutils literal">nsnapshot</tt> and
ran it through cron I’ve got completely unattended backups to either
local or remote storage, dynamically, just like I had on Time Machine.</p>
<p>One small and useful advice about cron setup if you are an Slackware
kind of person follows bellow (thanks to <a class="reference external" href="http://www.nickcoleman.org/blog/index.cgi/cronslackware!201112181115!unix">Nick Coleman</a>). Also, don’t
forget to include <tt class="docutils literal">ionice</tt> and <tt class="docutils literal">nice</tt> commands so your system still gets
usable while rsnapshot/rsync is doing its thing.</p>
<pre class="code bash literal-block">
<span class="c"># Run snapshot backup levels
</span>0 */4 * * * <span class="nv"><span class="caps">ID</span></span><span class="o">=</span>sshourly ionice -c 2 nice -n+19 /usr/local/bin/nsnapshot hourly &gt;&gt; /var/log/rsnapshot 2&gt;&amp;1
50 21-23 * * * <span class="nv"><span class="caps">ID</span></span><span class="o">=</span>ssdaily <span class="nv"><span class="caps">FREQ</span></span><span class="o">=</span>2h/1h ionice -c 2 nice -n+19 /usr/local/bin/nsnapshot daily &gt;&gt; /var/log/rsnapshot 2&gt;&amp;1
40 21-23 * * * <span class="nv"><span class="caps">ID</span></span><span class="o">=</span>ssweekly <span class="nv"><span class="caps">FREQ</span></span><span class="o">=</span>7d/1h ionice -c 2 nice -n+19 /usr/local/bin/nsnapshot weekly &gt;&gt; /var/log/rsnapshot 2&gt;&amp;1
30 21-23 * * * <span class="nv"><span class="caps">ID</span></span><span class="o">=</span>ssmonthly <span class="nv"><span class="caps">FREQ</span></span><span class="o">=</span>30d/1h ionice -c 2 nice -n+19 /usr/local/bin/nsnapshot monthly &gt;&gt; /var/log/rsnapshot 2&gt;&amp;1
</pre>
<div class="section" id="bonus-daft-punk-pharrell-get-lucky-snl-ad">
<h2><strong>Bonus</strong>: Daft Punk Pharrell "Get Lucky" <span class="caps">SNL</span> Ad</h2>
<div align="center" class="youtube"><iframe frameborder="0" height="281" src="https://www.youtube.com/embed/JMJwcOiBoZE" width="500"></iframe></div></div>

            </div><!-- /.entry-content -->
            <div class="share">
              <h4>Share This Article</h4>
              <a href="https://twitter.com/share" class="twitter-share-button" data-via="denydias" data-size="large" data-dnt="true">Tweet</a>
              <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
              <div class="g-plusone" data-annotation="inline" data-width="120"></div>
            </div>
            <div class="related">
              <hr class="related">
              <h3>Related Posts</h3>
                              <ul>
                                    <li><i class="icon-doc-text-inv"></i><a href="http://mexapi.macpress.com.br/2013/08//moving-slackware-to-kernel-310-fixes-to.html">Moving Slackware to kernel 3.10: <span class="caps">NVIDIA</span> and Broadcom drivers&nbsp;fixes</a></li>
                                      <li><i class="icon-doc-text-inv"></i><a href="http://mexapi.macpress.com.br/2013/04/keeping-slackware64-current-multilib-up.html">Keeping Slackware -current, multilib up-to-date kinda&nbsp;automatically</a></li>
                                      <li><i class="icon-doc-text-inv"></i><a href="http://mexapi.macpress.com.br/2012/11/subversao-tecnologica-do-mac-os-x-para.html">Subversão tecnológica: do Mac <span class="caps">OS</span> X para o Slackware Linux em um Apple MacBook&nbsp;Pro</a></li>
                                      <li><i class="icon-doc-text-inv"></i><a href="http://mexapi.macpress.com.br/2012/11/slackware14-apple-macbook-pro-and-audio.html">Slackware14, Apple MacBook Pro and audio&nbsp;quircks</a></li>
                                  </ul>
                            <hr class="related">
            </div><!-- /.related-posts -->
                        <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "2013/04/time-machineish-backups-under-linux.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://mexapi.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>
            

        </div><!-- /.eleven.columns -->
        
     <div class="three columns">


<h4>Categories</h4>
<ul>
			<li><i class="icon-plus-squared"></i><a href="http://mexapi.macpress.com.br/category/music.html">Music</a></li>
			<li><i class="icon-plus-squared"></i><a href="http://mexapi.macpress.com.br/category/politics.html">Politics</a></li>
			<li><i class="icon-plus-squared"></i><a href="http://mexapi.macpress.com.br/category/slackware.html">Slackware</a></li>
			<li><i class="icon-plus-squared"></i><a href="http://mexapi.macpress.com.br/category/society.html">Society</a></li>
	</ul>


<h4>Tags</h4>
	<ul>
		    <li class="tag-2"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/revolucao.html">revolução</a></li>
		    <li class="tag-2"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/subversao.html">subversão</a></li>
		    <li class="tag-1"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/tecnologia.html">tecnologia</a></li>
		    <li class="tag-1"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/linux.html">Linux</a></li>
		    <li class="tag-1"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/etica.html">ética</a></li>
		    <li class="tag-1"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/vida.html">vida</a></li>
		    <li class="tag-1"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/slackware.html">Slackware</a></li>
		    <li class="tag-2"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/pos-capitalismo.html">pós-capitalismo</a></li>
		    <li class="tag-2"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/utopia.html">utopia</a></li>
		    <li class="tag-2"><i class="icon-tag"></i><a href="http://mexapi.macpress.com.br/tag/software.html">software</a></li>
	</ul>



</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">
                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>. MexApi is licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/" target="_blank">CC BY-SA 3.0</a>.
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">

                                <li><div class="btn primary"><a href="https://github.com/denydias" target="_blank">Github</a></div></li>
                
                                <li><div class="btn twitter"><a href="https://twitter.com/denydias" target="_blank">Twitter</a></div></li>
                
                
                                <li><div class="btn danger"><a href="https://plus.google.com/104343775245895695882" target="_blank">Google+</a></div></li>
                
              </ul>
            </div>
          </div>
        </footer>

    </div>

<script type="text/javascript">
    var disqus_shortname = 'mexapi';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="http://mexapi.macpress.com.br/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="http://mexapi.macpress.com.br/theme/js/libs/gumby.min.js"></script>
  <script src="http://mexapi.macpress.com.br/theme/js/plugins.js"></script>

</body>
</html>